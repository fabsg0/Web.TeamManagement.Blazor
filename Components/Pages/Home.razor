@page "/"
@using fabsg0.Web.TeamManagement.Blazor.Components.MemberPopups
@using fabsg0.Web.TeamManagement.Blazor.Components.MembershipPopups
@using fabsg0.Web.TeamManagement.Blazor.Models
@using fabsg0.Web.TeamManagement.Blazor.Providers
@inject MemberProvider MemberProvider
@inject MembershipProvider MembershipProvider
@inject ILogger<Home> Logger
@rendermode InteractiveServer

<PageTitle>Home - TeamManagement</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="px-4 py-6">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div class="d-flex align-items-center gap-3">
            <h2 class="mb-0 fw-bold text-primary">👥 Members</h2>
            <MudSelect T="int" @bind-Value="_year" Dense Label="Year" Class="w-20" Immediate="true"
                       OnValueChanged="async _ => await FetchData()">
                @foreach (var year in _availableYears)
                {
                    <MudSelectItem Value="year">@year</MudSelectItem>
                }
            </MudSelect>
        </div>

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Outlined" OnClick="@(() => _showCreateYearMembershipPopup = true)">
                ➕ Create Year-Membership
            </MudButton>
            <MudButton Color="Color.Success" OnClick="@(() => _showCreateMemberPopup = true)">
                ➕ Add Member
            </MudButton>
            <MudButton Color="Color.Primary" OnClick="@(() => _showImportPopup = true)">
                ➕ Import Members
            </MudButton>
        </div>
    </div>

    @if (_isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto my-10"/>
    }
    else
    {
        <MudDataGrid T="MemberModel" Items="@_members" MultiSelection="true"
                     SortMode="SortMode.Multiple" Filterable="true" Class="border rounded shadow-sm">

            <Columns>
                <SelectColumn T="MemberModel"/>
                <PropertyColumn Property="x => x.Id" Title="#"/>
                <PropertyColumn Property="x => x.FirstName" Title="First Name"/>
                <PropertyColumn Property="x => x.LastName" Title="Last Name"/>
                <TemplateColumn T="MemberModel" Title="Membership">
                    <CellTemplate>
                        @{
                            var member = context.Item;
                        }

                        @if (member.CurrentMembershipFee is not null)
                        {
                            <MudButton Size="Size.Small"
                                       Color="@(member.CurrentMembershipFee.IsPaid ? Color.Success : Color.Error)"
                                       OnClick="@(() => ChangePaymentStatus(member.Id))"
                                       Class="me-2">
                                @(member.CurrentMembershipFee.IsPaid ? "Paid" : "Not Paid")
                            </MudButton>
                        }
                        else
                        {
                            <MudChip Color="Color.Default" Variant="Variant.Outlined" Class="me-2">Unknown</MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.BirthDate" Title="Birthdate" Format="dd.MM.yyyy"/>
                <TemplateColumn T="MemberModel" Title="Actions" Align="Align.Right">
                    <CellTemplate>
                        @{
                            var member = context.Item;
                        }

                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() =>
                                                {
                                                    _selectedMember = member;
                                                    _showUpdateMemberPopup = true;
                                                })"/>

                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() =>
                                                {
                                                    _selectedMember = member;
                                                    _showDeleteMemberPopup = true;
                                                })"/>
                    </CellTemplate>
                </TemplateColumn>

            </Columns>

            <PagerContent>
                <MudDataGridPager T="MemberModel"/>
            </PagerContent>
        </MudDataGrid>
    }
</MudContainer>

@if (_showCreateMemberPopup)
{
    <CreateMemberPopup OnClose="async () => { _showCreateMemberPopup = false; await FetchData(); }"/>
}
@if (_showUpdateMemberPopup)
{
    <UpdateMemberPopup Member="_selectedMember"
                       OnClose="async () => { _showUpdateMemberPopup = false; await FetchData(); }"/>
}
@if (_showDeleteMemberPopup)
{
    <DeleteMemberPopup MemberId="_selectedMember.Id"
                       OnClose="async () => { _showDeleteMemberPopup = false; await FetchData(); }"/>
}
@if (_showCreateYearMembershipPopup)
{
    <CreateYearMembershipPopup OnClose="async () => { _showCreateYearMembershipPopup = false; await FetchData(); }"/>
}
@if (_showImportPopup)
{
    <MemberImportPopup OnClose="async () => { _showImportPopup = false; await FetchData(); }"/>
}

@code {
    private List<MemberModel> _members = [];
    private bool _isLoading;
    private bool _showCreateMemberPopup;
    private bool _showUpdateMemberPopup;
    private bool _showDeleteMemberPopup;
    private bool _showImportPopup;
    private bool _showCreateYearMembershipPopup;
    private MemberModel _selectedMember = new();

    private int _year = DateTime.UtcNow.Year;
    private List<int> _availableYears = [];

    protected override async Task OnInitializedAsync()
    {
        await FetchData();
    }

    private async Task FetchData()
    {
        _isLoading = true;
        try
        {
            _members = await MemberProvider.GetMembers(_year);
            _availableYears = await MembershipProvider.GetMembershipYears();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to fetch data.");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ChangePaymentStatus(Guid memberId)
    {
        try
        {
            await MembershipProvider.ChangePaymentStatusForYear(memberId, _year);
            await FetchData();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to change payment status.");
        }
    }

}
